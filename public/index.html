<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üåç Container Tracking AI Demo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>

<body class="bg-gray-50 text-gray-900">
  <div class="container mx-auto px-4 py-6">
    <h1 class="text-3xl font-bold mb-2">üö¢ Container Tracking AI Platform</h1>
    <p class="text-sm text-gray-500 mb-6">Real-time vessel visibility, weather, ETA prediction, and AI summary.</p>

    <!-- Search -->
    <div class="bg-white shadow rounded-lg p-4 flex items-center space-x-3">
      <input id="cn" type="text" placeholder="Enter Container Number (e.g. MSCU1234000)" class="flex-1 border rounded p-2"/>
      <button onclick="lookup()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Search</button>
      <button onclick="generateSummaryForCurrent()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Generate Summary</button>
    </div>

    <!-- KPI Cards -->
    <div id="kpis" class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-6"></div>

    <!-- Map -->
    <div id="map" class="w-full h-96 mt-6 rounded-lg shadow"></div>

    <!-- Details -->
    <div id="details" class="bg-white rounded-lg shadow p-4 mt-6 text-sm"></div>

    <!-- Summary -->
    <div class="mt-6">
      <label for="summary" class="block text-sm font-medium text-gray-700 mb-1">üß† AI Summary</label>
      <textarea id="summary" rows="5" class="w-full border rounded-lg p-3 text-sm" placeholder="AI summary will appear here..."></textarea>
    </div>
  </div>

  <script>
    let map, markerShip, markerWp;

    // Initialize Leaflet map
    function initMap() {
      map = L.map('map').setView([20, 60], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);
    }
    initMap();

    // Render vessel on map
    function renderMap(vessel) {
      const { lat, lon, waypoint } = vessel;
      if (markerShip) map.removeLayer(markerShip);
      if (markerWp) map.removeLayer(markerWp);

      markerShip = L.marker([lat, lon]).addTo(map).bindPopup("üö¢ Current Location").openPopup();
      markerWp = L.marker([waypoint.lat, waypoint.lon]).addTo(map).bindPopup("üìç Next Waypoint");
      const group = L.featureGroup([markerShip, markerWp]);
      map.fitBounds(group.getBounds().pad(0.3));
    }

    // Render KPIs
    function renderKpis(metrics) {
      const html = `
        <div class="bg-white p-3 rounded shadow text-center"><div class="text-sm text-gray-500">Distance (nm)</div><div class="font-bold">${metrics.distNm.toFixed(1)}</div></div>
        <div class="bg-white p-3 rounded shadow text-center"><div class="text-sm text-gray-500">ETA (hrs)</div><div class="font-bold">${metrics.predHours.toFixed(1)}</div></div>
        <div class="bg-white p-3 rounded shadow text-center"><div class="text-sm text-gray-500">Risk</div><div class="font-bold text-${metrics.risk==='HIGH'?'red':'green'}-600">${metrics.risk}</div></div>
        <div class="bg-white p-3 rounded shadow text-center"><div class="text-sm text-gray-500">On-Time</div><div class="font-bold">${metrics.onTime ? '‚úÖ' : '‚ö†Ô∏è'}</div></div>`;
      document.getElementById('kpis').innerHTML = html;
    }

    // Load weather
    async function loadWeather(lat, lon) {
      try {
        const r = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
        const j = await r.json();
        const w = j.current || {};
        const html = `
          <div><b>üå°Ô∏è Temp:</b> ${w.temperature_2m ?? '-'}¬∞C | <b>üí® Wind:</b> ${w.wind_speed_10m ?? '-'} m/s</div>`;
        return html;
      } catch (e) {
        return `<div class="text-red-500">Weather unavailable</div>`;
      }
    }

    // Lookup container
    async function lookup() {
      const cn = document.getElementById('cn').value.trim();
      if (!cn) return alert("Please enter a container number");

      document.getElementById('details').innerHTML = "‚è≥ Searching...";
      try {
        const res = await fetch(`/api/container?cn=${encodeURIComponent(cn)}`);
        if (!res.ok) {
          const err = await res.json();
          const sug = err.suggestions || [];
          const msg = (err.error || "Not found") + (sug.length ? "<br><b>Suggestions:</b><br>" + sug.map(s =>
            typeof s === "string" ? s : `${s.sample} (${s.vessel})`
          ).join("<br>") : "");
          document.getElementById('details').innerHTML = `<div class="text-red-600">${msg}</div>`;
          return;
        }

        const j = await res.json();
        const it = j.item;
        renderMap(it);
        renderKpis(it.metrics);
        const weatherHtml = await loadWeather(it.lat, it.lon);

        const detailsHtml = `
          <div><b>Vessel:</b> ${it.vessel}</div>
          <div><b>Container IDs:</b> ${it.containers.slice(0,5).join(", ")}${it.containers.length>5?"...":""}</div>
          <div><b>ETA UTC:</b> ${it.metrics.etaUtc}</div>
          <div><b>Planned ETA (hrs):</b> ${it.etaPlannedHrs}</div>
          <div>${weatherHtml}</div>`;
        document.getElementById('details').innerHTML = detailsHtml;

        // üß† Dynamic summary from backend
        document.getElementById('summary').value = j.summary || "No summary available.";
      } catch (e) {
        document.getElementById('details').innerHTML = `<div class="text-red-600">${e.message}</div>`;
      }
    }

    // Generate summary for current container
    async function generateSummaryForCurrent() {
      const cn = document.getElementById('cn').value.trim();
      if (!cn) return alert("Enter a container first.");
      const r = await fetch(`/api/summary?cn=${encodeURIComponent(cn)}`, { method: "POST" });
      const j = await r.json();
      document.getElementById('summary').value = j.summary || "No summary found.";
    }
  </script>
</body>
</html>
